##!/usr/bin/expect -f

#Usage rollback_rscd_agent.expect <host> <ssh user> <ssh password>

set timeout 5

set cmd_line_patching {typeset -r rsc_home="/usr/lib/rsc/HOME"; [ -f "$rsc_home" ] && cd $(cat "$rsc_home")/bin && ls -la && [ -f rscd_full_CVE*.bak ] && mv rscd_full rscd_full.old && mv rscd_full_CVE*.bak rscd_full && /etc/init.d/rscd start;}


set check_rscd_is_running "ps -C rscd && echo RSCD OK : [lindex $argv 0];";

spawn ssh -o "StrictHostKeyChecking no" [lindex $argv 1]@[lindex $argv 0]

expect -re ".*assword.*" { send "[lindex $argv 2]\r"; }

#expect -re ".*# ?.*" { send_user "$cmd_line_patching\r\n"; send "$cmd_line_patching\r"; send_user "[lindex $argv 0]\r\n"; }
expect -re ".*# ?.*" { send "$cmd_line_patching\r"; }
expect -re ".*# ?.*" { send "$check_rscd_is_running\r"; }
expect -re ".*# ?.*"
send_user "\r\nDisconnecting of [lindex $argv 0] ...\r\n"

exit 0
